<?xml version="1.0" encoding="UTF-8"?>
<openerp>
    <data>

      # Messages for Budget Message
      <record id="action_budget_message_supervisor_approved" model="ir.actions.server">
          <field name="name">Budget Confirm</field>
          <field name="model_id" ref="pabi_budget_transfer.model_section_budget_transfer"/>
          <field name="state">code</field>
          <field name="condition">object.state == 'confirm'</field>
          <field name="code">
# Supervisor Confirmed
#  - owner = Maytinee
#  - boss = Chumchai
#  - action = False
#  - is_complete = False
object=object.with_context(lang='th_TH')
subject=object.name
body=u"%s วันที่ %s ขออนุมัติโอนงบประมาณจาก [%s]%s ไปให้ [%s]%s จำนวนเงิน %d บาท เหตุผล %s" % (object.name, object.date_prepare, object.transfer_line_ids.from_budget_id.section_id.code, object.transfer_line_ids.from_budget_id.section_id.name_short, object.transfer_line_ids.to_budget_id.section_id.code, object.transfer_line_ids.to_budget_id.section_id.name_short, object.transfer_line_ids.amount_transfer, object.transfer_line_ids.notes)
owner=object.preparer_user_id.login
employee_id = pool['hr.employee'].search(cr, uid, [('user_id', '=', object.preparer_user_id.id)], context=context)[0]
supervisor_id = pool['wkf.cmd.boss.level.approval'].get_supervisor(cr, uid, employee_id, context=context)
boss = pool['hr.employee'].browse(cr, uid, supervisor_id, context=context).employee_code
action=False
is_complete=False
pool.get('mail.thread').message_intray(cr, uid, object, subject, body, owner, boss, action, is_complete, context=context)
          </field>
      </record>
      <record id="action_budget_message_transfer" model="ir.actions.server">
          <field name="name">Budget Transfer</field>
          <field name="model_id" ref="pabi_budget_transfer.model_section_budget_transfer"/>
          <field name="state">code</field>
          <field name="condition">object.state == 'transfer' and object.transfer_line_ids.from_budget_id.section_id.division_id ==  object.transfer_line_ids.to_budget_id.section_id.division_id</field>
          <field name="code">
# Ready to Transfer
# - owner = Chumchai
# - boss = Maytinee
# - action = 'A'
# - is_complete = True
object=object.with_context(lang='th_TH')
subject=object.name
body=u"%sวันที่ %s อนุมัติโอนงบประมาณ เมื่อวันที่ %s โดยโอนงบประมาณ จาก[%s]%s ไปให้ [%s]%s จำนวนเงิน %d บาท เหตุผล %s" % (object.name, object.date_prepare, object.date_transfer, object.transfer_line_ids.from_budget_id.section_id.code, object.transfer_line_ids.from_budget_id.section_id.code, object.transfer_line_ids.to_budget_id.section_id.name_short, object.transfer_line_ids.to_budget_id.section_id.name_short, object.transfer_line_ids.amount_transfer, object.transfer_line_ids.notes)
employee_id = pool['hr.employee'].search(cr, uid, [('user_id', '=', object.preparer_user_id.id)], context=context)[0]
supervisor_id = pool['wkf.cmd.boss.level.approval'].get_supervisor(cr, uid, employee_id, context=context)
owner = pool['hr.employee'].browse(cr, uid, supervisor_id, context=context).employee_code
boss=object.preparer_user_id.login
action='A'
is_complete=True
pool.get('mail.thread').message_intray(cr, uid, object, subject, body, owner, boss, action, is_complete, context=context)
          </field>
      </record>

      # different division
      <record id="action_budget_message_approve_diff_division" model="ir.actions.server">
          <field name="name">Budget Approve</field>
          <field name="model_id" ref="pabi_budget_transfer.model_section_budget_transfer"/>
          <field name="state">code</field>
          <field name="condition">object.state == 'approve' and object.transfer_line_ids.from_budget_id.section_id.division_id !=  object.transfer_line_ids.to_budget_id.section_id.division_id</field>
          <field name="code">
# Ready to Approve
# - owner = Chumchai
# - boss = OuBudget
# - action = 'A'
# - is_complete = False
object=object.with_context(lang='th_TH')

subject=object.name
body=u"%sวันที่ %s ได้รับอนุมัติการโอนงบประมาณแล้ว เมื่อวันที่ %s โดยโอนงบประมาณ จาก[%s]%s ไปให้ [%s]%s จำนวนเงิน %d บาท เหตุผล %s ดังนั้นขอให้ฝ่ายงบประมาณดำเนินการโอนงบประมาณในระบบ" % (object.name, object.date_prepare, object.date_approve, object.transfer_line_ids.from_budget_id.section_id.code, object.transfer_line_ids.from_budget_id.section_id.name_short, object.transfer_line_ids.to_budget_id.section_id.code, object.transfer_line_ids.to_budget_id.section_id.name_short, object.transfer_line_ids.amount_transfer, object.transfer_line_ids.notes)
employee_id = pool['hr.employee'].search(cr, uid, [('user_id', '=', object.preparer_user_id.id)], context=context)[0]
supervisor_id = pool['wkf.cmd.boss.level.approval'].get_supervisor(cr, uid, employee_id, context=context)
owner = pool['hr.employee'].browse(cr, uid, supervisor_id, context=context).employee_code
ou_group = pool['res.groups'].search(cr, uid, [('name', '=', 'Operating Unit Budget')], context=context)
ou_user_group = pool['res.groups'].browse(cr, uid, ou_group, context=context).users.filtered(lambda l: l.default_operating_unit_id.id == object.org_id.id)
boss=[]
for rec in ou_user_group:
  boss.append(rec.login)
action='A'
is_complete=False
pool.get('mail.thread').message_intray(cr, uid, object, subject, body, owner, boss, action, is_complete, context=context)
          </field>
      </record>
      <record id="action_budget_message_transfer_diff_division" model="ir.actions.server">
          <field name="name">Budget Transfer Diff Division</field>
          <field name="model_id" ref="pabi_budget_transfer.model_section_budget_transfer"/>
          <field name="state">code</field>
          <field name="condition">object.state == 'transfer' and object.transfer_line_ids.from_budget_id.section_id.division_id !=  object.transfer_line_ids.to_budget_id.section_id.division_id</field>
          <field name="code">
# Ready to Transfer
# - owner = OuBudget
# - boss = Chumchai,Maytinee
# - action = 'A'
# - is_complete = True
object=object.with_context(lang='th_TH')
subject=object.name
body=u"%sวันที่ %s ฝ่ายงบประมาณดำเนินการโอนงบประมาณในระบบเรียบร้อยแล้ว เมื่อวันที่ %s โดยโอนงบประมาณ [%s]%s ไปให้ [%s]%s จำนวนเงิน %d บาท เหตุผล %s" % (object.name, object.date_prepare, object.date_transfer, object.transfer_line_ids.from_budget_id.section_id.code, object.transfer_line_ids.from_budget_id.section_id.name_short, object.transfer_line_ids.to_budget_id.section_id.code, object.transfer_line_ids.to_budget_id.section_id.name_short, object.transfer_line_ids.amount_transfer, object.transfer_line_ids.notes)
owner=object.transfer_user_id.login
boss=[object.preparer_user_id.login,object.approver_user_id.login]
action='A'
is_complete=True
pool.get('mail.thread').message_intray(cr, uid, object, subject, body, owner, boss, action, is_complete, context=context)
          </field>
      </record>
      <!-- Rule -->
      <record id="budget_message_intray_message" model="base.action.rule">
          <field name="name">Budget Message Intray Messages</field>
          <field name="model_id" ref="pabi_budget_transfer.model_section_budget_transfer"/>
          <field name="sequence">1</field>
          <field name="kind">on_write</field>
          <field name="server_action_ids"
            eval="[(6,0,[ref('action_budget_message_supervisor_approved'),
                         ref('action_budget_message_transfer'),
                         ref('action_budget_message_approve_diff_division'),
                         ref('action_budget_message_transfer_diff_division')])]"/>
      </record>

    </data>
</openerp>
